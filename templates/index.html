<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>Visualization Final Project</title>

  <script src="{{ url_for('static', filename='js/d3.v4.min.js')}}"></script>
  <script src="{{ url_for('static', filename='js/jquery-2.2.4.min.js')}}"></script>
  <script src="{{ url_for('static', filename='js/queue.v1.min.js')}}"></script>
  <script src="{{ url_for('static', filename='js/d3-tip.js')}}"></script>
  <script src="{{ url_for('static', filename='js/topojson.min.js')}}"></script>
  <script src="https://d3js.org/d3-color.v2.min.js"></script>
  <script src="https://d3js.org/d3-interpolate.v2.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v2.min.js"></script>
  <script src="https://d3js.org/d3-time.v2.min.js"></script>
  <script src="https://d3js.org/d3-time-format.v3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>




  <!-- <link rel='stylesheet' type="text/css" href="{{ url_for('static', filename='styles/button.css')}}" />
  <link rel='stylesheet' type="text/css" href="{{ url_for('static', filename='styles/main.css')}}" />
  <link rel='stylesheet' type="text/css" href="{{ url_for('static', filename='styles/d3-tip.css')}}" />
  <link rel='stylesheet' type="text/css" href="{{ url_for('static', filename='styles/parallel.css')}}" /> -->
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/inspcetor.css')}}">

  <!-- <script src="{{ url_for('static', filename='js/parallelCoords.js')}}"></script>
  <script src="{{ url_for('static', filename='js/worldMap.js')}}"></script>
  <script src="{{ url_for('static', filename='js/barChart.js')}}"></script> -->
<script src="{{ url_for('static', filename='js/donut.js')}}"></script>

  <link rel='stylesheet' type="text/css" href="{{ url_for('static', filename='styles/style.css')}}" />
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <script type="module">
  import { updateWorldMap, createWorldMap } from './static/js/worldMap.js'
  import { createLineChart } from './static/js/line-chart.module.js'
  import { createMdsPlot } from './static/js/mds-plot.module.js'
  import { createBubbleScatterplot } from './static/js/bubble-scatterplot.module.js'
  import { createParallelCoordsPlot } from './static/js/parallel-coords.module.js'
  import {Runtime, Library, Inspector} from "./static/js/runtime.js";
  import { define } from "./static/js/race.js";



  var _selectedCountries = [];


let Attrelement = "GDP"

    document.getElementById("reset-button").addEventListener("click", resetData);

    d3.csv("/static/data/Visualization_final.csv", function (err, demoData) {
 
    
      _selectedCountries = [];
     console.log(demoData);
      let demographicData = cleanData(demoData);
      // localStorage.setItem('data', JSON.stringify(demographicData));
      console.log("in Index:");
    console.log(demographicData);
      
      console.log(demographicData);
      let filteredDemographicData = demographicData;
 
      createLineChart("#parallel-coordinates-plot", demographicData ,"GDP");
      createWorldMap("#world-map", demographicData , "GDP") ;
      createBubbleScatterplot("#donut-charts", demographicData , "Life_Expectancy");
      createParallelCoordsPlot("#time-series-line-chart", demographicData);
      
      
     // listing to data selection changes
     document.addEventListener("worldMapClicked", function (event) {

       _selectedCountries = event.detail.selectedCountries;
       if (_selectedCountries.length === 0) {
         filteredDemographicData = demographicData;
       } else {
         filteredDemographicData = demographicData.filter(el => _selectedCountries.includes(el.country_name));
       }
       console.log("in update block")
       console.log(filteredDemographicData);
       
       console.log(filteredDemographicData);
        var attr= Attrelement 
        var attrB=Attrelement
       if(Attrelement=="GDP")
       {
       console.log("no attr");
           attr="GDP";
           attrB="Life_Expectancy"
           }
     
       // update time line chart
       createLineChart("#parallel-coordinates-plot", filteredDemographicData , attr);
     createBubbleScatterplot("#donut-charts", filteredDemographicData , attrB);
    createParallelCoordsPlot("#time-series-line-chart", filteredDemographicData);
    });
    
    
      // event listener for bubblePlotBrushed
      document.addEventListener("bubblePlotBrushed", function (event) {
        _selectedCountries = event.detail.selectedCountries;
        
         var attr= Attrelement     
         if(Attrelement=="GDP")
         {
         console.log("no attr");
             attr="GDP";
             }
       

        // update time line chart
        if (_selectedCountries.length === 0) {
          createLineChart("#parallel-coordinates-plot", demographicData , attr);
          createWorldMap("#world-map", demographicData , attr);
          createBubbleScatterplot("#donut-charts", demographicData ,"Life_Expectancy" );
        createParallelCoordsPlot("#time-series-line-chart", demographicData);

        } else {
          filteredDemographicData = demographicData.filter(el => _selectedCountries.includes(el.country_name));
          createLineChart("#parallel-coordinates-plot", filteredDemographicData , attr);
          updateWorldMap("#world-map", filteredDemographicData , attr);
                    createParallelCoordsPlot("#time-series-line-chart", filteredDemographicData);
          
        }
      })


document.addEventListener("change", function (event) {
 
 console.log("in donut event listener");

let optionSelected =  event.detail.data;
Attrelement=optionSelected;
console.log("In donut event index")
 console.log(Attrelement);
       createLineChart("#parallel-coordinates-plot", demographicData ,optionSelected);
      createWorldMap("#world-map", demographicData , optionSelected) ;
     createBubbleScatterplot("#donut-charts", demographicData , optionSelected);
     
  
    setVisible("#bubble-scatterplot",false)
    let svgContainer = d3.select("#race")
    if (svgContainer) svgContainer.selectAll("*").remove();
    setVisible("#race",true)
        localStorage.setItem('data',optionSelected);
       const runtime = new Runtime();
      const main = runtime.module(define, Inspector.into('#race'));
      
      //  var ele=document.getElementById("vis-header");
      //  ele.textContent=Attrelement;
       var h1 = document.getElementById("donut-header1");
            h1.textContent = Attrelement;

    if (document.getElementById("back").style.display=='none') {
           setVisible("#back",true)
    }
      

   
});


document.addEventListener("timePlotBrushed", function (event) {
        let timeRange = [event.detail.timeRange[0].getFullYear(), event.detail.timeRange[1].getFullYear()];
        if (_selectedCountries.length === 0) {
          filteredDemographicData = demographicData
        } else {
          filteredDemographicData = demographicData.filter(countryData => _selectedCountries.includes(countryData.country_name))
        }

        filteredDemographicData = filteredDemographicData.map(countryData => {

          let yearwiseData = countryData.yearwiseData.filter(yearlyData => {
            let year = parseInt(yearlyData.year)
            return (year >= parseInt(timeRange[0]) && year <= parseInt(timeRange[1]))
          })

          return ({
            "country_name": countryData.country_name,
            "yearwiseData": yearwiseData
          })
        })

        console.log(filteredDemographicData);
        var attr= Attrelement 
        var attrB=Attrelement
       
       if(Attrelement=="GDP")
       {
       console.log("no attr");
           attr="GDP";
           attrB="Life_Expectancy"
           }
        // update world map
        updateWorldMap("#world-map", filteredDemographicData,attr);
       createBubbleScatterplot("#donut-charts", filteredDemographicData , attrB);
    createParallelCoordsPlot("#time-series-line-chart", filteredDemographicData);
      })
      
     })
     
     

    function resetData() {
    
    console.log("in reset");
    // document.getElementById("loader").style.display = "none";


    // window.location.reload();
    
      _selectedCountries = []

      _selectedCountries = [];
      if(document.getElementById("back").style.display=='block')
          document.getElementById("back").click();
      
      
      d3.csv("/static/data/Visualization_final.csv", function (err, demoData) {
      
        let demographicData = cleanData(demoData);
            console.log(demographicData);
        createLineChart("#parallel-coordinates-plot", demographicData, "GDP");
        createWorldMap("#world-map", demographicData , "GDP");
        createBubbleScatterplot("#donut-charts", demographicData,"Life_Expectancy");
        createParallelCoordsPlot("#time-series-line-chart", demographicData);
      })
    }


    function setVisible(selector, visible) {
      document.querySelector(selector).style.display = visible ? 'block' : 'none';
    }

    //create mds plot
    function createMds(data) {
      setVisible('#mds-corr-plot', true);
      setVisible('#mds-plot-loader', false);
      let headers = data['data'][0].headers;
      let MdsRandCorrData = data['data'][0].data;
      let randomInputData = data['data'][0].randomInputData;


      let plotData = [];

      randomInputData.forEach((inputData, i) => {
        plotData.push({
          "x": MdsRandCorrData[i][0],
          "y": MdsRandCorrData[i][1],
          "country": inputData[0],
          "year": inputData[1],
          "GDP": inputData[2],
          "Annual_CO2_emissions": inputData[5],
          "Tourism": inputData[7],
          "Literacy_Rates": inputData[15],
        })
      })
      createMdsPlot("#mds-corr-plot", plotData)
    }

    //clean data to use in visualizations
   function cleanData(demographicData) {
     let consizeDemographicData = []

     demographicData.forEach(dataPoint => {
       if (!consizeDemographicData.some(el => el.country_name === dataPoint.country_name)) {
           console.log(dataPoint);
         consizeDemographicData.push({
           "country_name": dataPoint.country_name,
           "yearwiseData": [{
             "year": dataPoint.Year,
             "data": {
               "GDP":dataPoint.GDP,
               "Life_Expectancy": dataPoint.Life_Expectancy,
               "Annual_CO2_emissions": dataPoint.Annual_CO2_emissions,
               "Population": dataPoint.Population,
               "Mortality_Rate":dataPoint.Mortality_Rate,
               "Tourism":dataPoint.Tourism,
               "Terrorism":dataPoint.Terrorism,
               "Homicide_Rate":dataPoint.Homicide_Rate,
               "Depression_percent":dataPoint.Depression_percent
             }
           }]
         })

       } else {

         consizeDemographicData.find(el => el.country_name === dataPoint.country_name)["yearwiseData"].push({
           "year": dataPoint.Year,
           "data": {
             "GDP":dataPoint.GDP,
             "Life_Expectancy": dataPoint.Life_Expectancy,
             "Annual_CO2_emissions": dataPoint.Annual_CO2_emissions,
             "Population": dataPoint.Population,
             "Mortality_Rate":dataPoint.Mortality_Rate,
             "Tourism":dataPoint.Tourism,
             "Terrorism":dataPoint.Terrorism,
             "Homicide_Rate":dataPoint.Homicide_Rate,
             "Depression_percent":dataPoint.Depression_percent
           }
         })
       }
     })
     return consizeDemographicData
   }
   
   
   
  </script>

<script>
function back_button()
{
setVisible("#race",false);
setVisible("#bubble-scatterplot",true);
      var ele=document.getElementById("donut-header1");
      ele.textContent="Donut-Chart";


if (document.getElementById("back").style.display=='none') {
   setVisible("#back",true)
}
else
{
   setVisible("#back",false)
}
}

function setVisible(selector, visible) {
  document.querySelector(selector).style.display = visible ? 'block' : 'none';
}
</script>

<canvas id="projector">Your browser does not support the Canvas element.</canvas>
<script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.0/TweenMax.min.js"></script>


</head>

<body>
   

  <div class="loader">

    <h3 class="loaderHeading">Global Statistics Dashboard</h3>

  </div>

  <div class="background">
    <!-- <div class="vector-circle vector-circle0"></div>
    <div class="vector-circle vector-circle1"></div>
    <div class="vector-circle vector-circle2"></div> -->
  </div>
  
  
   
      <nav id="dashboard-header">
    <h3 class="dashboard-header-head">Global Statistics Dashboard</h3>
    <button id="reset-button" >Reset data</button>
  </nav>
     
    
  </nav>

  <section id="body" class="dashboard">

    <div class="flex0">

      <div id='world-map-container'>
        <h2 class="vis-header-no-marg" id="vis-header">World Map</h2>
        <div id='world-map'></div>
      </div>

      <div class="line-seperator"></div>

      <div id='parallel-coordinates-plot-container'>
        <div id='parallel-coordinates-plot'> </div>
      </div>

    </div>

    <div class="flex1">
    
     <div class="flex2">
     
       <div class="marginTop" id='bubble-scatterplot-container'>
        <h2 id="donut-header1" style="padding-top: 20px;">Donut-Chart</h2>
         <div id='bubble-scatterplot'> </div>
         <button id="back" type="button"  onclick="back_button()" style="float:right; display:none;" ></button>
        <div id='race' style="display:none;">
        </div>
       </div>



       <div class="marginTop" id='donut-charts-container'>
          <div id='donut-charts'></div>
        </div>
      </div>
   

      <div class="marginTop" id='time-series-line-chart-container'>
        <div id='time-series-line-chart'></div>
      </div>

     

    </div>

  </section>
  
  

  <script src="/static/js/app.js"></script>

</body>


</html>


<script>
  ////////////////////////// PARTICLE ENGINE ////////////////////////////////////////
 /////////////////////////////////////////////////////////////////////////////////////////
 
 var ParticleEngine = (function() {
   'use strict';
 
   function ParticleEngine(canvas_id) {
     // enforces new
     if (!(this instanceof ParticleEngine)) {
       return new ParticleEngine(args);
     }
     
     var _ParticleEngine = this;
 
     this.canvas_id = canvas_id;
     this.stage = new createjs.Stage(canvas_id);
     this.totalWidth = this.canvasWidth = document.getElementById(canvas_id).width = document.getElementById(canvas_id).offsetWidth;
     this.totalHeight = this.canvasHeight = document.getElementById(canvas_id).height = document.getElementById(canvas_id).offsetHeight;
     this.compositeStyle = "lighter";
 
     this.particleSettings = [{id:"small", num:300, fromX:0, toX:this.totalWidth, ballwidth:3, alphamax:0.4, areaHeight:.5, color:"#0cdbf3", fill:false}, 
                 {id:"medium", num:100, fromX:0, toX:this.totalWidth,  ballwidth:8, alphamax:0.3, areaHeight:1, color:"#6fd2f3", fill:true}, 
                 {id:"large", num:10, fromX:0, toX:this.totalWidth, ballwidth:30,  alphamax:0.2, areaHeight:1, color:"#93e9f3", fill:true}];
     this.particleArray = [];
     this.lights = [{ellipseWidth:400, ellipseHeight:100, alpha:0.6, offsetX:0, offsetY:0, color:"#6ac6e8"}, 
             {ellipseWidth:350, ellipseHeight:250, alpha:0.3, offsetX:-50, offsetY:0, color:"#54d5e8"}, 
             {ellipseWidth:100, ellipseHeight:80, alpha:0.2, offsetX:80, offsetY:-50, color:"#2ae8d8"}];
 
     this.stage.compositeOperation = _ParticleEngine.compositeStyle;
 
 
     function drawBgLight()
     {
       var light;
       var bounds;
       var blurFilter;
       for (var i = 0, len = _ParticleEngine.lights.length; i < len; i++) {				
         light = new createjs.Shape();
         light.graphics.beginFill(_ParticleEngine.lights[i].color).drawEllipse(0, 0, _ParticleEngine.lights[i].ellipseWidth, _ParticleEngine.lights[i].ellipseHeight);
         light.regX = _ParticleEngine.lights[i].ellipseWidth/2;
         light.regY = _ParticleEngine.lights[i].ellipseHeight/2; 
         light.y = light.initY = _ParticleEngine.totalHeight/2 + _ParticleEngine.lights[i].offsetY;
         light.x = light.initX =_ParticleEngine.totalWidth/2 + _ParticleEngine.lights[i].offsetX;
 
         blurFilter = new createjs.BlurFilter(_ParticleEngine.lights[i].ellipseWidth, _ParticleEngine.lights[i].ellipseHeight, 1);
         bounds = blurFilter.getBounds();
         light.filters = [blurFilter];
         light.cache(bounds.x-_ParticleEngine.lights[i].ellipseWidth/2, bounds.y-_ParticleEngine.lights[i].ellipseHeight/2, bounds.width*2, bounds.height*2);
         light.alpha = _ParticleEngine.lights[i].alpha;
 
         light.compositeOperation = "screen";
         _ParticleEngine.stage.addChildAt(light, 0);
 
         _ParticleEngine.lights[i].elem = light;
       }
 
       TweenMax.fromTo(_ParticleEngine.lights[0].elem, 10, {scaleX:1.5, x:_ParticleEngine.lights[0].elem.initX, y:_ParticleEngine.lights[0].elem.initY},{yoyo:true, repeat:-1, ease:Power1.easeInOut, scaleX:2, scaleY:0.7});
       TweenMax.fromTo(_ParticleEngine.lights[1].elem, 12, { x:_ParticleEngine.lights[1].elem.initX, y:_ParticleEngine.lights[1].elem.initY},{delay:5, yoyo:true, repeat:-1, ease:Power1.easeInOut, scaleY:2, scaleX:2, y:_ParticleEngine.totalHeight/2-50, x:_ParticleEngine.totalWidth/2+100});
       TweenMax.fromTo(_ParticleEngine.lights[2].elem, 8, { x:_ParticleEngine.lights[2].elem.initX, y:_ParticleEngine.lights[2].elem.initY},{delay:2, yoyo:true, repeat:-1, ease:Power1.easeInOut, scaleY:1.5, scaleX:1.5, y:_ParticleEngine.totalHeight/2, x:_ParticleEngine.totalWidth/2-200});
     }
     
     var blurFilter;
     function drawParticles(){
 
       for (var i = 0, len = _ParticleEngine.particleSettings.length; i < len; i++) {
         var ball = _ParticleEngine.particleSettings[i];
 
         var circle;
         for (var s = 0; s < ball.num; s++ )
         {
           circle = new createjs.Shape();
           if(ball.fill){
             circle.graphics.beginFill(ball.color).drawCircle(0, 0, ball.ballwidth);
             blurFilter = new createjs.BlurFilter(ball.ballwidth/2, ball.ballwidth/2, 1);
             circle.filters = [blurFilter];
             var bounds = blurFilter.getBounds();
             circle.cache(-50+bounds.x, -50+bounds.y, 100+bounds.width, 100+bounds.height);
           }else{
             circle.graphics.beginStroke(ball.color).setStrokeStyle(1).drawCircle(0, 0, ball.ballwidth);
           }
           
           circle.alpha = range(0, 0.1);
           circle.alphaMax = ball.alphamax;
           circle.distance = ball.ballwidth * 2;
           circle.ballwidth = ball.ballwidth;
           circle.flag = ball.id;
           _ParticleEngine.applySettings(circle, ball.fromX, ball.toX, ball.areaHeight);
           circle.speed = range(2, 10);
           circle.y = circle.initY;
           circle.x = circle.initX;
           circle.scaleX = circle.scaleY = range(0.3, 1);
 
           _ParticleEngine.stage.addChild(circle);
           
 
           animateBall(circle);
 
           _ParticleEngine.particleArray.push(circle);
         }
       }	
     }
 
     this.applySettings = function(circle, positionX, totalWidth, areaHeight)
     {
       circle.speed = range(1, 3);
       circle.initY = weightedRange(0, _ParticleEngine.totalHeight , 1, [_ParticleEngine.totalHeight * (2-areaHeight/2)/4, _ParticleEngine.totalHeight*(2+areaHeight/2)/4], 0.8 );
       circle.initX = weightedRange(positionX, totalWidth, 1, [positionX+ ((totalWidth-positionX))/4, positionX+ ((totalWidth-positionX)) * 3/4], 0.6);
     }
 
     function animateBall(ball)
     {
       var scale = range(0.3, 1);
       var xpos = range(ball.initX - ball.distance, ball.initX + ball.distance);
       var ypos = range(ball.initY - ball.distance, ball.initY + ball.distance);
       var speed = ball.speed;
       TweenMax.to(ball, speed, {scaleX:scale, scaleY:scale, x:xpos, y:ypos, onComplete:animateBall, onCompleteParams:[ball], ease:Cubic.easeInOut});	
       TweenMax.to(ball, speed/2, {alpha:range(0.1, ball.alphaMax), onComplete:fadeout, onCompleteParams:[ball, speed]});	
     }	
 
     function fadeout(ball, speed)
     {
       ball.speed = range(2, 10);
       TweenMax.to(ball, speed/2, {alpha:0 });
     }
 
     drawBgLight();
     drawParticles();
   }
 
   ParticleEngine.prototype.render = function()
   {
     this.stage.update();
   }
 
   ParticleEngine.prototype.resize = function()
   {
     this.totalWidth = this.canvasWidth = document.getElementById(this.canvas_id).width = document.getElementById(this.canvas_id).offsetWidth;
     this.totalHeight = this.canvasHeight = document.getElementById(this.canvas_id).height = document.getElementById(this.canvas_id).offsetHeight;
     this.render();
 
     for (var i= 0, length = this.particleArray.length; i < length; i++)
     {
       this.applySettings(this.particleArray[i], 0, this.totalWidth, this.particleArray[i].areaHeight);
     }
 
     for (var j = 0, len = this.lights.length; j < len; j++) {
       this.lights[j].elem.initY = this.totalHeight/2 + this.lights[j].offsetY;
       this.lights[j].elem.initX =this.totalWidth/2 + this.lights[j].offsetX;
       TweenMax.to(this.lights[j].elem, .5, {x:this.lights[j].elem.initX, y:this.lights[j].elem.initY});			
     }
   }
 
   return ParticleEngine;
 
 }());
 
 
 ////////////////////////UTILS//////////////////////////////////////
 //////////////////////////////////////////////////////////////////
 
 function range(min, max)
 {
   return min + (max - min) * Math.random();
 }
     
 function round(num, precision)
 {
    var decimal = Math.pow(10, precision);
    return Math.round(decimal* num) / decimal;
 }
 
 function weightedRange(to, from, decimalPlaces, weightedRange, weightStrength)
 {
   if (typeof from === "undefined" || from === null) { 
       from = 0; 
   }
   if (typeof decimalPlaces === "undefined" || decimalPlaces === null) { 
       decimalPlaces = 0; 
   }
   if (typeof weightedRange === "undefined" || weightedRange === null) { 
       weightedRange = 0; 
   }
   if (typeof weightStrength === "undefined" || weightStrength === null) { 
       weightStrength = 0; 
   }
 
    var ret
    if(to == from){return(to);}
  
    if(weightedRange && Math.random()<=weightStrength){
     ret = round( Math.random()*(weightedRange[1]-weightedRange[0]) + weightedRange[0], decimalPlaces )
    }else{
     ret = round( Math.random()*(to-from)+from, decimalPlaces )
    }
    return(ret);
 }
 
 ///////////////// RUN CODE //////////////////////////
 //////////////////////////////////////////////////////
 
 var particles
 (function(){
   particles = new ParticleEngine('projector');
   createjs.Ticker.addEventListener("tick", updateCanvas);
   window.addEventListener('resize', resizeCanvas, false);
 
   function updateCanvas(){
     particles.render();
   }
 
   function resizeCanvas(){
     particles.resize();
   }
 }());
  
  
  
  
  
  
  
  
  </script>